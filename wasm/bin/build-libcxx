#!/bin/zsh
set -e
cd "$(dirname "$0")/.."

declare -a cflags
cflags+=("-nostdinc" "-nostdinc++" "-std=c++11")
cflags+=("-target" "wasm32" "-S" "-emit-llvm" "-O3")
cflags+=("-Isrc/arch/wasm32" "-Isrc/musl/arch/generic")
cflags+=("-Ibuild/musl/src/internal" "-Isrc/musl/src/internal")
cflags+=("-Ibuild/musl/include" "-isystem" "src/musl/include")
cflags+=("-Isrc/libunwind/include")
cflags+=("-Isrc/libcxxabi/include")
cflags+=("-Isrc/libcxx/include")
cflags+=("-D_XOPEN_SOURCE=700")
cflags+=("-D_LIBCPP_HAS_NO_THREADS")
cflags+=("-D_LIBCXXABI_HAS_NO_THREADS")
cflags+=("-D__CLANG_MAX_ALIGN_T_DEFINED")
cflags+=("-D_LIBCPP_HAS_MUSL_LIBC")
cflags+=("-DLIBCXX_BUILDING_LIBCXXABI")
cflags+=("-fno-threadsafe-statics")

cflags+=("-D__sync_add_and_fetch(x,y)=(*(x)+=(y))")

declare -a objs
for i in src/libcxx/src/*.cpp; do
  name="${i#src/libcxx/src/}"
  obj="build/libcxx/${name%.cpp}.ll"
  objs+=("${obj}")
  mkdir -p "$(dirname ${obj})"
  clang++ "${cflags[@]}" -o "${obj}" "$i"
done

llvm-link -S -o build/libcxx.ll "${objs[@]}"
