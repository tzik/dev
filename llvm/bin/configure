#!/bin/bash
set -ex
cd "$(dirname "$0")/.."
base_dir="${PWD}"
out_dir="${base_dir}/out"
src_dir="${base_dir}/src"
llvm_dir="${src_dir}/llvm"
build_dir="${base_dir}/build"

declare -a opts
opts+=("-GNinja" "-Wno-dev")

opts+=("-DCMAKE_INSTALL_PREFIX=${out_dir}")
opts+=("-DCMAKE_BUILD_TYPE=Release")
opts+=("-DCMAKE_C_COMPILER=clang")
opts+=("-DCMAKE_CXX_COMPILER=clang++")

opts+=("-DLLVM_CCACHE_BUILD=ON")
opts+=("-DLLVM_TARGETS_TO_BUILD=X86;AArch64;ARM")
opts+=("-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=WebAssembly")
opts+=("-DBUILD_SHARED_LIBS=ON")

opts+=("-DLIBCXX_CXX_ABI_INTREE=ON")

opts+=("-DLLVM_EXTERNAL_PROJECTS=chromium-tools")

for i in clang compiler-rt libcxx libcxxabi lld clang-tools-extra chromium-tools; do
  upper="$(echo "$i" | tr '[:lower:]-' '[:upper:]_')"
  var_name="LLVM_EXTERNAL_${upper}_SOURCE_DIR"
  var_value="${src_dir}/$i"
  opts+=("-D${var_name}=${var_value}")
  opts+=("-DLLVM_TOOL_${upper}_BUILD=ON")
done

opts+=("-DLIBCXX_USE_COMPILER_RT=ON")
opts+=("-DLIBCXX_CXX_ABI=libcxxabi")
opts+=("-DLIBCXX_CXX_ABI_INCLUDE_PATHS=${src_dir}/libcxxabi/include")
opts+=("-DLIBCXXABI_LIBCXX_INCLUDES=${src_dir}/libcxx/include")

declare -a chromium_tools
chromium_tools+=("base_bind_rewriters")
chromium_tools+=("plugins" "blink_gc_plugin")

glue() {
    local IFS=";"
    echo "$*"
}

opts+=("-DCHROMIUM_TOOLS=$(glue "${chromium_tools[@]}")")

# opts+=("-DLLVM_POLLY_BUILD=ON")

mkdir -p "${build_dir}"
cd "${build_dir}"
cmake "${opts[@]}" "${llvm_dir}"
